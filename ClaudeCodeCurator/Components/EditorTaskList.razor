@namespace ClaudeCodeCurator.Components
@using ClaudeCodeCurator.Models
@using ClaudeCodeCurator.Entities
@using ClaudeCodeCurator.Common
@inject EditorState EditorState

<div class="mt-4">
    <h4 class="text-sm font-medium text-gray-700 mb-2">Tasks</h4>
    
    @if (UserStory.Tasks.Any())
    {
        <div class="space-y-2">
            @foreach (var task in UserStory.Tasks.OrderBy(t => t.TaskNumber))
            {
                <div class="border border-gray-200 rounded p-2 hover:bg-gray-50 cursor-pointer" 
                     @onclick="() => ViewTask(task)">
                    <div class="flex items-center">
                        <div class="flex-grow">
                            <div class="flex items-center">
                                <span class="text-xs px-1.5 py-0.5 rounded @GetTaskTypeClass(task.Type) mr-2">
                                    @task.Type
                                </span>
                                <span class="text-xs bg-gray-200 rounded px-1 mr-2">T-@task.TaskNumber</span>
                                <h5 class="text-sm font-medium truncate">@task.Name</h5>
                            </div>
                            
                            <div class="text-xs text-gray-400 mt-1">
                                @if (task.ApprovedByUserUtc.HasValue)
                                {
                                    <span class="px-1.5 py-0.5 rounded bg-green-100 text-green-800 text-xs mr-2">Approved</span>
                                }
                                @if (task.RequestedByAiUtc.HasValue)
                                {
                                    <span class="px-1.5 py-0.5 rounded bg-blue-100 text-blue-800 text-xs mr-2">Requested</span>
                                }
                                @if (task.FinishedByAiUtc.HasValue)
                                {
                                    <span class="px-1.5 py-0.5 rounded bg-purple-100 text-purple-800 text-xs mr-2">Finished</span>
                                }
                                @if (task.Paused)
                                {
                                    <span class="px-1.5 py-0.5 rounded bg-yellow-100 text-yellow-800 text-xs mr-2">Paused</span>
                                }
                            </div>
                        </div>
                        <div>
                            <button class="text-gray-400 hover:text-blue-600" title="Edit task" 
                                    @onclick:stopPropagation="true" @onclick="() => EditTask(task)">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="text-sm text-gray-500">
            No tasks available for this user story.
        </div>
    }
    
    <div class="mt-3">
        <button @onclick="CreateTask" class="text-sm text-blue-600 hover:text-blue-800 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 mr-1">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
            </svg>
            Add Task
        </button>
    </div>
</div>

@code {
    [Parameter]
    public UserStoryModel UserStory { get; set; } = null!;
    
    private void ViewTask(TaskModel task)
    {
        EditorState.ShowViewTask(task, UserStory);
    }
    
    private void EditTask(TaskModel task)
    {
        EditorState.ShowEditTask(task, UserStory);
    }
    
    private void CreateTask()
    {
        EditorState.ShowCreateTask(UserStory);
    }
    
    private string GetTaskTypeClass(TaskType type)
    {
        return type switch
        {
            TaskType.Bug => "bg-red-100 text-red-800",
            TaskType.Verify => "bg-green-100 text-green-800",
            _ => "bg-blue-100 text-blue-800"
        };
    }
}